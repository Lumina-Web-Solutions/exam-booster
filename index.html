<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPC PALA | Biometric Admin</title>
     <link rel="icon" type="image/png" href="assets/logo.png">
    <style>
        :root {
            --primary: #0062cc;
            --secondary: #6c757d;
            --dark: #1e293b;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f8fafc;
        }

        * { box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; margin: 0; padding: 0; }
        body { background-color: var(--bg); color: var(--dark); display: none; } /* Hidden until password correct */
        
        /* Sidebar Styling */
        .sidebar { width: 260px; background: var(--dark); color: white; position: fixed; height: 100vh; padding: 20px; box-shadow: 4px 0 10px rgba(0,0,0,0.1); }
        .sidebar h2 { font-size: 1.2rem; margin-bottom: 2rem; color: #94a3b8; border-bottom: 1px solid #334155; padding-bottom: 1rem; text-align: center; }
        .nav-link { display: flex; align-items: center; color: #cbd5e1; padding: 12px 15px; text-decoration: none; cursor: pointer; border-radius: 8px; margin-bottom: 8px; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { background: var(--primary); color: white; }

        /* Main Content */
        .main { margin-left: 260px; padding: 40px; }
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: none; }
        .card.active { display: block; animation: fadeIn 0.3s ease; }

        /* Modern Table */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th { background: #f1f5f9; padding: 15px; text-align: center; font-size: 0.85rem; color: #64748b; text-transform: uppercase; }
        td { padding: 15px; text-align: center; border-bottom: 1px solid #e2e8f0; font-size: 0.95rem; }
        tr:hover { background: #f8fafc; }

        /* UI Elements */
        .btn { padding: 10px 18px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; margin-right: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { border: 1px solid var(--primary); color: var(--primary); background: transparent; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        
        input, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; margin-top: 5px; margin-bottom: 15px; }
        .search-bar { width: 300px; margin-bottom: 0; }
        
        .badge { padding: 4px 10px; border-radius: 99px; font-size: 0.75rem; font-weight: 700; }
        .morning { background: #dcfce7; color: #166534; }
        .noon { background: #fef9c3; color: #854d0e; }
        .evening { background: #dbeafe; color: #1e40af; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body id="bodyTag">

    <div class="sidebar">
        <h2>BIOMETRIC ADMIN <br> <span style="font-size: 0.7rem; font-weight: normal;">S4 EEE - GOVT POLY PALA</span></h2>
        <div class="nav-link active" onclick="showTab('dashboard')">üìä Live Dashboard</div>
        <div class="nav-link" onclick="showTab('manager')">üë• Student Database</div>
        <div class="nav-link" onclick="showTab('controls')">‚öôÔ∏è Hardware Control</div>
        <div class="nav-link" onclick="location.reload()" style="margin-top: 50px; color: var(--danger);">üîí Logout</div>
    </div>

    <div class="main">
        <div id="dashboard" class="card active">
            <div class="header-flex">
                <h3>Attendance Register</h3>
                <input type="text" id="searchInput" class="search-bar" onkeyup="searchTable()" placeholder="üîç Search Name or Roll No...">
            </div>
            
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="fetchAttendance()">üîÑ Sync Live</button>
                <button class="btn btn-outline" onclick="exportToExcel()">üì• Export Excel</button>
                <button class="btn btn-outline" onclick="printReport()">üñ®Ô∏è Print PDF</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Date</th><th>Time</th><th>Roll</th><th>Student Name</th><th>Shift</th><th>Finger ID</th>
                    </tr>
                </thead>
                <tbody id="attendance-data"></tbody>
            </table>
        </div>

        <div id="manager" class="card">
            <h3>Student Database Management</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div style="border-right: 1px solid #eee; padding-right: 20px;">
                    <h4>Add New Student</h4><br>
                    <label>Roll No</label><input type="text" id="rollNo">
                    <label>Admission No</label><input type="text" id="admNo">
                    <label>Name</label><input type="text" id="studentName">
                    <button class="btn btn-primary" onclick="addStudent()">Save Student</button>
                </div>
                <div>
                    <h4>Enrolled List</h4><br>
                    <button class="btn btn-outline" onclick="fetchStudentList()">View All Students</button>
                    <table style="font-size: 0.8rem; margin-top: 10px;">
                        <thead><tr><th>Roll</th><th>Name</th><th>Status</th></tr></thead>
                        <tbody id="student-list-data"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="controls" class="card">
            <h3>Hardware System Configuration</h3>
            <div style="max-width: 500px;">
                <div style="background: #fffbeb; padding: 20px; border-radius: 8px; border: 1px solid #fef3c7; margin-bottom: 20px;">
                    <h4>Enrollment Mode</h4>
                    <p style="font-size: 0.85rem; color: #92400e; margin-bottom: 10px;">Warning: This puts the device in setup mode.</p>
                    <label>Target Student Roll No:</label>
                    <input type="text" id="enrollRollNo" placeholder="Enter Roll No">
                    <button class="btn btn-warning" onclick="triggerEnroll()">Start Remote Scan</button>
                </div>

                <div style="background: #f1f5f9; padding: 20px; border-radius: 8px;">
                    <h4>Shift Timing Override</h4>
                    <select id="shiftSelect">
                        <option value="AUTO">Automatic (Clock Based)</option>
                        <option value="Morning">Force Morning</option>
                        <option value="Noon">Force Noon</option>
                        <option value="Evening">Force Evening</option>
                    </select>
                    <button class="btn btn-danger" onclick="overrideShift()">Update Hardware Shift</button>
                </div>
            </div>
        </div>
        <p id="globalStatus" style="position: fixed; bottom: 20px; right: 20px; font-weight: bold;"></p>
    </div>

    <script>
        // --- AUTHENTICATION ---
        const PWD = "EEE-PALAS4"; // CHANGE PASSWORD HERE
        let auth = prompt("Enter Admin Password:");
        if(auth === PWD) {
            document.getElementById('bodyTag').style.display = 'block';
        } else {
            alert("Wrong Password. Access Denied.");
            window.stop();
        }

        // --- LINKS ---
        const reportsCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSHN7IJeMNngUbF_7hiUPC5AbGYRMldhdMasmDoew4PS27wKWpNd7tWqQ_5TMsWbRKS79i4fo2klUWC/pub?gid=0&single=true&output=csv';
        const databaseCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSHN7IJeMNngUbF_7hiUPC5AbGYRMldhdMasmDoew4PS27wKWpNd7tWqQ_5TMsWbRKS79i4fo2klUWC/pub?gid=791939148&single=true&output=csv';
        const apiUrl = 'https://script.google.com/macros/s/AKfycbyrzjswavIWdXjeefFm0JOgr2Lvl-f6hZg3SosRMjzO1VG_JZo1Bit9fR69GUlWzjTF/exec';

        function showTab(id) {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        async function fetchAttendance() {
            const res = await fetch(reportsCsvUrl);
            const data = await res.text();
            const rows = data.split('\n').slice(4); // Match your sheet (row 5 start)
            const body = document.getElementById('attendance-data');
            body.innerHTML = '';
            rows.reverse().forEach(row => {
                if(row.trim()){
                    const c = row.split(',');
                    const shiftClass = c[4].toLowerCase();
                    body.innerHTML += `<tr>
                        <td>${c[0]}</td><td>${c[1]}</td><td>${c[2]}</td>
                        <td style="text-align:left">${c[3]}</td>
                        <td><span class="badge ${shiftClass}">${c[4]}</span></td>
                        <td>${c[5]}</td>
                    </tr>`;
                }
            });
        }

        async function sendCommand(payload) {
            document.getElementById('globalStatus').innerText = "‚è≥ Processing...";
            try {
                await fetch(apiUrl, { method: 'POST', body: JSON.stringify(payload) });
                document.getElementById('globalStatus').innerText = "‚úÖ Done";
            } catch {
                document.getElementById('globalStatus').innerText = "‚ùå Failed";
            }
        }

        function addStudent() {
            sendCommand({
                action: "add_student",
                roll_no: document.getElementById('rollNo').value,
                adm_no: document.getElementById('admNo').value,
                name: document.getElementById('studentName').value
            });
        }

        function triggerEnroll() {
            const roll = document.getElementById('enrollRollNo').value;
            sendCommand({ action: "set_control", mode: "ENROLL", target_roll: roll });
        }

        function overrideShift() {
            sendCommand({ action: "set_control", shift_override: document.getElementById('shiftSelect').value });
        }

        function searchTable() {
            let filter = document.getElementById("searchInput").value.toUpperCase();
            let rows = document.getElementById("attendance-data").getElementsByTagName("tr");
            for (let i = 0; i < rows.length; i++) {
                rows[i].style.display = rows[i].innerText.toUpperCase().includes(filter) ? "" : "none";
            }
        }

        function exportToExcel() {
            window.open(reportsCsvUrl); // Easiest way to download current raw data
        }

        function printReport() {
            window.print();
        }

        fetchAttendance();
    </script>
</body>
</html>
